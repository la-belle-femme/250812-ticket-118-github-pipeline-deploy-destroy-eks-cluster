name: Destroy EKS Cluster

on:
  workflow_dispatch:
    inputs:
      confirm_destroy:
        description: 'Type "DESTROY" to confirm cluster destruction'
        required: true
        type: string
      destroy_backend:
        description: 'Also destroy S3 bucket and DynamoDB table (WARNING: This will delete state)'
        required: false
        default: false
        type: boolean

env:
  TF_VERSION: "1.9.5"
  AWS_REGION: "us-east-1"

permissions:
  id-token: write
  contents: read
  actions: write

jobs:
  validate-input:
    name: "Validate Destruction Input"
    runs-on: ubuntu-latest
    steps:
    - name: Validate Confirmation
      run: |
        if [[ "${{ github.event.inputs.confirm_destroy }}" != "DESTROY" ]]; then
          echo "âŒ Destruction not confirmed. You must type 'DESTROY' to proceed."
          echo "You typed: '${{ github.event.inputs.confirm_destroy }}'"
          exit 1
        fi
        echo "âœ… Destruction confirmed"

  destroy-cluster:
    name: "Destroy EKS Infrastructure"
    runs-on: ubuntu-latest
    needs: validate-input
    environment: 
      name: development
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
        role-session-name: GitHubActions-Destroy-${{ github.run_id }}
        aws-region: ${{ env.AWS_REGION }}

    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v3
      with:
        terraform-version: ${{ env.TF_VERSION }}

    - name: Get Backend Configuration
      id: backend-config
      run: |
        # Use the exact bucket name we know exists
        BUCKET_NAME="eks-tfstate-us-east-1-d91584e3"
        DYNAMODB_TABLE="eks-tfstate-locks-d91584e3"
        
        # Verify bucket exists and has state file
        echo "ðŸ“¦ Checking S3 bucket: $BUCKET_NAME"
        aws s3 ls s3://$BUCKET_NAME/terraform.tfstate
        
        if [ $? -eq 0 ]; then
          echo "âœ… Found Terraform state file"
        else
          echo "âŒ No state file found in bucket"
          exit 1
        fi
        
        echo "bucket_name=$BUCKET_NAME" >> $GITHUB_OUTPUT
        echo "dynamodb_table=$DYNAMODB_TABLE" >> $GITHUB_OUTPUT
        
        echo "ðŸ“¦ Using S3 bucket: $BUCKET_NAME"
        echo "ðŸ”’ Using DynamoDB table: $DYNAMODB_TABLE"
        
        # Create backend config file
        cat > backend.tf << EOF
        terraform {
          backend "s3" {
            bucket         = "$BUCKET_NAME"
            key            = "terraform.tfstate"
            region         = "${{ env.AWS_REGION }}"
            dynamodb_table = "$DYNAMODB_TABLE"
            encrypt        = true
          }
        }
        EOF
        
        echo "âœ… Backend configuration created"
        cat backend.tf

    - name: Terraform Init
      id: init
      run: terraform init

    - name: Terraform Plan Destroy (EKS Resources Only)
      if: github.event.inputs.destroy_backend == 'false'
      id: plan-destroy-eks
      run: |
        terraform plan -destroy \
          -var-file="terraform.tfvars" \
          -target=aws_eks_node_group.main \
          -target=aws_eks_cluster.main \
          -target=aws_iam_openid_connect_provider.eks \
          -target=aws_security_group.eks_nodes \
          -target=aws_security_group.eks_cluster \
          -target=aws_security_group_rule.cluster_ingress_node_https \
          -target=aws_iam_role_policy_attachment.eks_worker_node_policy \
          -target=aws_iam_role_policy_attachment.eks_cni_policy \
          -target=aws_iam_role_policy_attachment.eks_container_registry_policy \
          -target=aws_iam_role_policy_attachment.eks_cluster_policy \
          -target=aws_iam_role_policy_attachment.eks_vpc_resource_controller \
          -target=aws_iam_role.eks_node_group \
          -target=aws_iam_role.eks_cluster \
          -target=aws_cloudwatch_log_group.eks_cluster \
          -out=destroy-eks.tfplan \
          -detailed-exitcode
      continue-on-error: true

    - name: Terraform Plan Destroy (All Resources)
      if: github.event.inputs.destroy_backend == 'true'
      id: plan-destroy-all
      run: |
        terraform plan -destroy \
          -var-file="terraform.tfvars" \
          -out=destroy-all.tfplan \
          -detailed-exitcode
      continue-on-error: true

    - name: Show Destruction Plan
      run: |
        echo "## ðŸš¨ DESTRUCTION PLAN" >> $GITHUB_STEP_SUMMARY
        echo "The following resources will be **PERMANENTLY DELETED**:" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [[ "${{ github.event.inputs.destroy_backend }}" == "true" ]]; then
          echo "### âš ï¸ COMPLETE DESTRUCTION (INCLUDING STATE BACKEND)" >> $GITHUB_STEP_SUMMARY
          echo "- EKS Cluster and all related resources" >> $GITHUB_STEP_SUMMARY
          echo "- S3 Bucket (Terraform state) - **THIS CANNOT BE UNDONE**" >> $GITHUB_STEP_SUMMARY
          echo "- DynamoDB Table (state locking)" >> $GITHUB_STEP_SUMMARY
          echo "- All IAM roles and policies" >> $GITHUB_STEP_SUMMARY
        else
          echo "### ðŸŽ¯ EKS CLUSTER DESTRUCTION (PRESERVING STATE BACKEND)" >> $GITHUB_STEP_SUMMARY
          echo "- EKS Cluster and Node Groups" >> $GITHUB_STEP_SUMMARY
          echo "- Security Groups" >> $GITHUB_STEP_SUMMARY
          echo "- IAM Roles and Policies (EKS-related)" >> $GITHUB_STEP_SUMMARY
          echo "- CloudWatch Log Groups" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**PRESERVED:**" >> $GITHUB_STEP_SUMMARY
          echo "- S3 Bucket (Terraform state)" >> $GITHUB_STEP_SUMMARY
          echo "- DynamoDB Table (state locking)" >> $GITHUB_STEP_SUMMARY
          echo "- GitHub OIDC configuration" >> $GITHUB_STEP_SUMMARY
        fi

    - name: Terraform Destroy (EKS Resources Only)
      if: |
        github.event.inputs.destroy_backend == 'false' &&
        (steps.plan-destroy-eks.outcome == 'success' || steps.plan-destroy-eks.outputs.exitcode == '2')
      run: |
        echo "ðŸš¨ Starting EKS cluster destruction..."
        terraform apply -auto-approve destroy-eks.tfplan
        echo "âœ… EKS cluster destroyed successfully!"

    - name: Terraform Destroy (All Resources)
      if: |
        github.event.inputs.destroy_backend == 'true' &&
        (steps.plan-destroy-all.outcome == 'success' || steps.plan-destroy-all.outputs.exitcode == '2')
      run: |
        echo "ðŸš¨ Starting complete infrastructure destruction..."
        terraform apply -auto-approve destroy-all.tfplan
        echo "âœ… All resources destroyed successfully!"

    - name: Cleanup State Bucket (if requested)
      if: github.event.inputs.destroy_backend == 'true'
      run: |
        BUCKET_NAME="${{ steps.backend-config.outputs.bucket_name }}"
        echo "ðŸ§¹ Cleaning up state bucket: $BUCKET_NAME"
        
        # Remove all objects from the bucket
        aws s3 rm s3://$BUCKET_NAME --recursive || true
        
        # Remove all object versions (if versioning is enabled)
        aws s3api list-object-versions --bucket $BUCKET_NAME --query 'Versions[].{Key:Key,VersionId:VersionId}' --output text | while read key version; do
          if [[ -n "$key" && -n "$version" ]]; then
            aws s3api delete-object --bucket $BUCKET_NAME --key "$key" --version-id "$version" || true
          fi
        done
        
        # Remove delete markers
        aws s3api list-object-versions --bucket $BUCKET_NAME --query 'DeleteMarkers[].{Key:Key,VersionId:VersionId}' --output text | while read key version; do
          if [[ -n "$key" && -n "$version" ]]; then
            aws s3api delete-object --bucket $BUCKET_NAME --key "$key" --version-id "$version" || true
          fi
        done
        
        echo "âœ… State bucket cleanup completed"

    - name: Verify Destruction
      run: |
        echo "## ðŸ” DESTRUCTION VERIFICATION" >> $GITHUB_STEP_SUMMARY
        
        # Check if EKS cluster still exists
        CLUSTER_NAME="eks-cluster-d91584e3"
        if aws eks describe-cluster --name "$CLUSTER_NAME" --region ${{ env.AWS_REGION }} 2>/dev/null; then
          echo "âŒ EKS cluster still exists!" >> $GITHUB_STEP_SUMMARY
          exit 1
        else
          echo "âœ… EKS cluster successfully destroyed" >> $GITHUB_STEP_SUMMARY
        fi
        
        if [[ "${{ github.event.inputs.destroy_backend }}" == "true" ]]; then
          BUCKET_NAME="${{ steps.backend-config.outputs.bucket_name }}"
          if aws s3 ls "s3://$BUCKET_NAME" 2>/dev/null; then
            echo "âŒ S3 bucket still exists!" >> $GITHUB_STEP_SUMMARY
          else
            echo "âœ… S3 bucket successfully destroyed" >> $GITHUB_STEP_SUMMARY
          fi
          
          DYNAMODB_TABLE="${{ steps.backend-config.outputs.dynamodb_table }}"
          if aws dynamodb describe-table --table-name "$DYNAMODB_TABLE" --region ${{ env.AWS_REGION }} 2>/dev/null; then
            echo "âŒ DynamoDB table still exists!" >> $GITHUB_STEP_SUMMARY
          else
            echo "âœ… DynamoDB table successfully destroyed" >> $GITHUB_STEP_SUMMARY
          fi
        fi

    - name: Cleanup Workflow Artifacts
      if: github.event.inputs.destroy_backend == 'true'
      run: |
        echo "ðŸ§¹ Cleaning up GitHub workflow artifacts..."
        # This step would ideally clean up any stored kubeconfig artifacts
        echo "Note: Manually remove any stored kubeconfig artifacts from previous runs"

    - name: Final Summary
      run: |
        echo "## ðŸŽ‰ DESTRUCTION COMPLETED" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Destruction Details:**" >> $GITHUB_STEP_SUMMARY
        echo "- **Confirmation**: ${{ github.event.inputs.confirm_destroy }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Destroy Backend**: ${{ github.event.inputs.destroy_backend }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Timestamp**: $(date -u)" >> $GITHUB_STEP_SUMMARY
        echo "- **Actor**: @${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [[ "${{ github.event.inputs.destroy_backend }}" == "true" ]]; then
          echo "âš ï¸ **COMPLETE DESTRUCTION**: All infrastructure and state has been permanently deleted." >> $GITHUB_STEP_SUMMARY
          echo "To redeploy, you will need to run the deploy workflow from scratch." >> $GITHUB_STEP_SUMMARY
        else
          echo "ðŸŽ¯ **CLUSTER DESTRUCTION**: EKS cluster destroyed, state backend preserved." >> $GITHUB_STEP_SUMMARY
          echo "You can redeploy the cluster anytime using the existing state backend." >> $GITHUB_STEP_SUMMARY
        fi